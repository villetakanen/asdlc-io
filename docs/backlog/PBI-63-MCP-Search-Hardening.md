# PBI-63: MCP Search Hardening

> Status: Ready

## Directive

Address resilience, consistency, and testing gaps identified in the adversarial review of the MCP Fuzzy Search implementation (PBI-60-62).

**Scope:**
- `.gitignore` (add `src/mcp/articles.json`)
- `netlify/edge-functions/mcp.ts` (add try-catch fallback)
- `tests/mcp/` (add artifact integration test)

## Dependencies
- Blocked by: None
- Must merge before: None

## Context

Source: Adversarial review of commits `f3e1dd3`, `fdd0fc6`, `a16ff06`.

Three findings warrant action:

1. **Build fragility:** `src/mcp/articles.json` is committed but `src/mcp/fuse-index.json` is gitignored. Both are generated by the same `prebuild` script. Inconsistent.
2. **No error handling:** `Fuse.parseIndex()` in `getMcpServer()` has no try-catch. A corrupted index crashes the entire edge function with no fallback.
3. **No artifact integration test:** Unit tests use mock fixtures. No test verifies the real generated `fuse-index.json` loads correctly with `ContentService`.

Two findings were assessed as not actionable now:
- **Memory/scalability** (articles.json + fuse-index.json ~530KB total, well within 20MB limit at 40 articles) — revisit if corpus exceeds 200 articles.
- **Type safety** (`@ts-ignore` on JSON imports) — pre-existing pattern required for Deno/Node cross-compat, not introduced by this epic.

## Changes Required

**1. `.gitignore`:**
Add `src/mcp/articles.json` alongside the existing `src/mcp/fuse-index.json` entry. Both are generated build artifacts.

**2. `netlify/edge-functions/mcp.ts`:**
Wrap the Fuse index initialization in `getMcpServer()` with a try-catch. On failure, log the error and construct ContentService without a pre-built index (Fuse will build it at runtime from the articles array — slower but functional).

```typescript
function getMcpServer() {
  if (!mcpServer) {
    let fuseIndex;
    try {
      fuseIndex = Fuse.parseIndex<Article>(...);
    } catch (e) {
      console.error('Failed to parse pre-built Fuse index, falling back to runtime indexing:', e);
    }
    contentService = new ContentService(articles as Article[], fuseIndex);
    mcpServer = new McpServer(contentService);
  }
  return mcpServer;
}
```

**3. `tests/mcp/` (new test file or extend existing):**
Add an integration test that:
- Runs `node scripts/generate-mcp-index.mjs` (or imports the existing generated files)
- Loads the real `src/mcp/articles.json` and `src/mcp/fuse-index.json`
- Constructs a `ContentService` with both
- Verifies a search query returns results
- Verifies the index can be parsed by `Fuse.parseIndex()`

## Verification
- [ ] `src/mcp/articles.json` is covered by `.gitignore`
- [ ] `getMcpServer()` has try-catch around `Fuse.parseIndex()`
- [ ] Edge function still works if `fuse-index.json` is corrupted (fallback path)
- [ ] Integration test loads real generated artifacts and searches successfully
- [ ] `pnpm test:run` — all tests pass
- [ ] `pnpm check` — zero type errors
- [ ] `pnpm build` — succeeds

## Notes
- The fallback path (no pre-built index) means Fuse builds the index at runtime from the articles array. This is slower on cold start but functionally identical.
- After gitignoring `articles.json`, run `git rm --cached src/mcp/articles.json` to remove it from tracking without deleting the file.
- The integration test should be skipped in CI if the generated files don't exist (e.g., `describe.skipIf(!existsSync(...))`).

## Blocks
- None

## Related
- Adversarial review of PBI-60-62
- `netlify/edge-functions/mcp.ts:28-36`
- `scripts/generate-mcp-index.mjs`
