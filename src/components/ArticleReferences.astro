---
import type { Reference } from "../content/config";

interface Props {
  references: Reference[];
}

const { references } = Astro.props;

// Don't render if no references
if (!references || references.length === 0) {
  return null;
}

// Helper: Normalize author/authors to array for consistent rendering
function getAuthors(ref: Reference): string[] {
  if (ref.authors && ref.authors.length > 0) {
    return ref.authors;
  }
  if (ref.author) {
    return [ref.author];
  }
  return [];
}

// Helper: Format date for display
function formatDate(date: Date | undefined): string | null {
  if (!date) return null;
  return date.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}

// Helper: Format year from date
function formatYear(date: Date | undefined): string | null {
  if (!date) return null;
  return date.getFullYear().toString();
}

// Helper: Format authors list (APA style)
function formatAuthorList(authors: string[]): string {
  if (authors.length === 0) return "";
  if (authors.length === 1) return authors[0];
  if (authors.length === 2) return `${authors[0]} & ${authors[1]}`;

  // 3+ authors: First, Second, & Last
  const allButLast = authors.slice(0, -1).join(", ");
  const last = authors[authors.length - 1];
  return `${allButLast}, & ${last}`;
}
---

<section class="article-references">
  <h2>References</h2>
  <ol class="reference-list">
    {references.map((ref) => {
      const authors = getAuthors(ref);
      const authorList = formatAuthorList(authors);
      const year = formatYear(ref.published);
      const accessedDate = formatDate(ref.accessed);

      return (
        <li class={`reference reference--${ref.type}`}>
          <cite class="reference-citation">
            {authorList && (
              <>
                <span class="reference-author">{authorList}</span>
                {year && ` (${year})`}.
              </>
            )}
            {!authorList && year && (
              <>({year}).</>
            )}
            {' '}
            {ref.url ? (
              <a href={ref.url} class="reference-title" rel="external noopener">
                {ref.title}
              </a>
            ) : (
              <span class="reference-title">{ref.title}</span>
            )}
            .
            {ref.publisher && (
              <> <span class="reference-publisher">{ref.publisher}</span>.</>
            )}
            {ref.isbn && (
              <> <span class="reference-isbn">ISBN: {ref.isbn}</span>.</>
            )}
            {ref.doi && (
              <> <span class="reference-doi">DOI: {ref.doi}</span>.</>
            )}
            {accessedDate && (
              <> <span class="reference-accessed">Accessed {accessedDate}</span>.</>
            )}
          </cite>
          <p class="reference-annotation">
            {ref.annotation}
          </p>
        </li>
      );
    })}
  </ol>
</section>

<style>
  .article-references {
    margin-block: calc(var(--s-grid) * 2);
    padding-block-start: var(--s-gap);
    border-block-start: 1px solid var(--c-border);
  }

  .article-references h2 {
    font-family: var(--f-sans);
    font-size: 1.5rem;
    font-weight: 700;
    margin-block-end: var(--s-grid);
    color: var(--c-text-primary);
  }

  .reference-list {
    list-style: decimal;
    padding-inline-start: var(--s-grid);
    margin: 0;
  }

  .reference {
    margin-block-end: var(--s-grid);
  }

  .reference-citation {
    font-style: normal;
    display: block;
    color: var(--c-text-primary);
    line-height: 1.6;
  }

  .reference-author {
    font-weight: 700;
  }

  .reference-title {
    font-style: italic;
  }

  .reference-title[href] {
    color: var(--c-brand);
    text-decoration: none;
  }

  .reference-title[href]:hover {
    color: var(--c-brand-hover);
    text-decoration: underline;
  }

  .reference-publisher,
  .reference-isbn,
  .reference-doi,
  .reference-accessed {
    color: var(--c-text-secondary);
  }

  .reference-annotation {
    color: var(--c-text-secondary);
    font-size: 0.875rem;
    line-height: 1.5;
    margin-block-start: calc(var(--s-grid) * 0.5);
    margin-block-end: 0;
  }
</style>
